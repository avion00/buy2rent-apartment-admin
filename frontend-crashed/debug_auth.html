<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Auth Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test { margin: 15px 0; padding: 15px; border-radius: 6px; border-left: 4px solid #ccc; }
        .success { background-color: #d4edda; border-left-color: #28a745; }
        .error { background-color: #f8d7da; border-left-color: #dc3545; }
        .warning { background-color: #fff3cd; border-left-color: #ffc107; }
        .info { background-color: #d1ecf1; border-left-color: #17a2b8; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 4px; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; border-radius: 4px; font-size: 12px; }
        input { padding: 8px; margin: 5px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
        .user-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }
        .user-info { display: flex; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Authentication Debug Tool</h1>
        <p><strong>Purpose:</strong> Debug user authentication and profile data loading.</p>
        
        <div class="test info">
            <h3>ğŸ“‹ Current Status</h3>
            <div id="currentStatus">Loading...</div>
        </div>

        <div style="margin: 20px 0;">
            <button class="btn-primary" onclick="checkCurrentAuth()">ğŸ” Check Current Auth</button>
            <button class="btn-success" onclick="testLogin()">ğŸšª Test Login</button>
            <button class="btn-danger" onclick="testLogout()">ğŸšª Test Logout</button>
            <button class="btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
        </div>

        <div>
            <h3>ğŸ” Test Login</h3>
            <input type="email" id="email" placeholder="Email" value="amc8808@gmail.com">
            <input type="password" id="password" placeholder="Password" value="">
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        function addResult(title, status, message, data = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            
            let statusClass = 'info';
            if (status.includes('SUCCESS') || status.includes('âœ…')) statusClass = 'success';
            if (status.includes('ERROR') || status.includes('âŒ')) statusClass = 'error';
            if (status.includes('WARNING') || status.includes('âš ï¸')) statusClass = 'warning';
            
            div.className = `test ${statusClass}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <p><strong>${status}</strong></p>
                <p>${message}</p>
                ${data ? `<pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>` : ''}
                <small>â° ${new Date().toLocaleTimeString()}</small>
            `;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function updateCurrentStatus() {
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            const statusDiv = document.getElementById('currentStatus');
            
            if (accessToken) {
                statusDiv.innerHTML = `
                    <div class="success test">
                        <strong>âœ… AUTHENTICATED</strong><br>
                        Access Token: ${accessToken.substring(0, 50)}...<br>
                        Refresh Token: ${refreshToken ? refreshToken.substring(0, 50) + '...' : 'Not found'}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="error test">
                        <strong>âŒ NOT AUTHENTICATED</strong><br>
                        No access token found in localStorage
                    </div>
                `;
            }
        }

        async function checkCurrentAuth() {
            addResult('ğŸ” Current Auth Check', 'CHECKING', 'Verifying current authentication status...');
            
            const accessToken = localStorage.getItem('access_token');
            
            if (!accessToken) {
                addResult('ğŸ” Current Auth Check', 'âŒ ERROR', 'No access token found in localStorage');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/profile/`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    addResult('ğŸ” Current Auth Check', 'âœ… SUCCESS', 'User is authenticated and profile loaded successfully!', userData);
                    
                    // Show user card
                    const userCard = `
                        <div class="user-card">
                            <div class="user-info">
                                <div class="avatar">${userData.first_name?.charAt(0) || 'U'}${userData.last_name?.charAt(0) || ''}</div>
                                <div>
                                    <strong>${userData.first_name} ${userData.last_name}</strong><br>
                                    <small>${userData.email}</small><br>
                                    <small>@${userData.username} ${userData.is_staff ? '(Staff)' : ''}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    addResult('ğŸ‘¤ User Profile', 'âœ… SUCCESS', 'Current user profile:', userCard);
                } else {
                    const errorData = await response.json();
                    addResult('ğŸ” Current Auth Check', 'âŒ ERROR', `Profile request failed: ${response.status}`, errorData);
                }
            } catch (error) {
                addResult('ğŸ” Current Auth Check', 'âŒ ERROR', `Request failed: ${error.message}`);
            }
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                addResult('ğŸšª Login Test', 'âŒ ERROR', 'Please enter both email and password');
                return;
            }
            
            addResult('ğŸšª Login Test', 'TESTING', `Attempting login for ${email}...`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store tokens
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    
                    addResult('ğŸšª Login Test', 'âœ… SUCCESS', 'Login successful! Tokens stored.', data);
                    updateCurrentStatus();
                    
                    // Automatically check profile
                    setTimeout(checkCurrentAuth, 1000);
                } else {
                    addResult('ğŸšª Login Test', 'âŒ ERROR', `Login failed: ${response.status}`, data);
                }
            } catch (error) {
                addResult('ğŸšª Login Test', 'âŒ ERROR', `Login request failed: ${error.message}`);
            }
        }

        async function testLogout() {
            addResult('ğŸšª Logout Test', 'TESTING', 'Testing logout...');
            
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (!refreshToken) {
                addResult('ğŸšª Logout Test', 'âš ï¸ WARNING', 'No refresh token found, clearing local storage only');
                localStorage.clear();
                updateCurrentStatus();
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/logout/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh: refreshToken })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.clear();
                    addResult('ğŸšª Logout Test', 'âœ… SUCCESS', 'Logout successful! Tokens cleared.', data);
                    updateCurrentStatus();
                } else {
                    addResult('ğŸšª Logout Test', 'âŒ ERROR', `Logout failed: ${response.status}`, data);
                }
            } catch (error) {
                addResult('ğŸšª Logout Test', 'âŒ ERROR', `Logout request failed: ${error.message}`);
            }
        }

        // Auto-update status on page load
        window.onload = function() {
            updateCurrentStatus();
            setTimeout(checkCurrentAuth, 500);
        };
    </script>
</body>
</html>
